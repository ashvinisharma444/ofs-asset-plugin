<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OFS Handshake Successful</title>
</head>
<body style="display:flex; justify-content:center; align-items:center; height:100vh; font-family:sans-serif; background:#f4f7f6;">
    <div style="text-align:center; background:white; padding:40px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
        <h1 id="status">Waiting for Handshake...</h1>
        <p id="debug-info" style="color:#888;">Checking for signal from Oracle Field Service...</p>
        <button onclick="closeNow()" style="margin-top:20px; padding:10px 20px; cursor:pointer;">Return to Oracle</button>
    </div>

    <script>
        var origin = "";

        window.addEventListener("message", function(event) {
            // This is the most important part for debugging
            console.log("RECEIVED FROM ORACLE:", event.data);
            
            var data;
            try {
                data = (typeof event.data === 'string') ? JSON.parse(event.data) : event.data;
            } catch (e) {
                console.error("Data parse error:", e);
                return;
            }

            // Once the 'init' method is received, we MUST reply immediately
            if (data.method === "init") {
                origin = event.origin;
                document.getElementById('status').innerText = "Connected!";
                document.getElementById('debug-info').innerText = "Handshake complete. You are now synced.";

                // SEND READY SIGNAL
                var readyMsg = {
                    apiVersion: 1,
                    method: 'ready'
                };
                
                // Send as an object and a string to be 100% sure
                window.parent.postMessage(readyMsg, origin);
                window.parent.postMessage(JSON.stringify(readyMsg), origin);
                
                console.log("SENT TO ORACLE: ready");
            }
        }, false);

        function closeNow() {
            var closeMsg = { apiVersion: 1, method: 'close' };
            window.parent.postMessage(JSON.stringify(closeMsg), origin);
        }
    </script>
</body>
</html>
