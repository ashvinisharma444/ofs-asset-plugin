<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Inspection Plugin</title>
    <style>
        :root { --primary: #0073e6; --success: #28a745; --bg: #f4f7f6; --pending: #ffc107; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: #333; }
        .header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; display: flex; align-items: center; gap: 10px; z-index: 100; }
        .view { display: none; padding: 15px; }
        .view.active { display: block; }
        
        /* List UI */
        .asset-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; cursor:pointer; }
        .asset-item.done { border-left-color: var(--success); }
        .asset-item.pending { border-left-color: var(--pending); }
        .asset-info b { display: block; font-size: 1.1em; }
        
        /* Inputs */
        .search-bar { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; margin-top: 10px; }
        
        /* Buttons */
        .btn { padding: 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 16px; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn-main { background: var(--primary); color: white; }
        .btn-save { background: var(--success); color: white; }
        .btn-back { background: transparent; color: white; border: 1px solid white; padding: 5px 10px; width: auto; margin: 0; }
        
        #qr-scanner { width: 100%; height: 200px; background: #000; display:none; border-radius: 8px; margin-bottom: 10px; }
        .empty-state { text-align: center; color: #888; margin-top: 50px; padding: 20px; }
    </style>
</head>
<body>

<div id="view-list" class="view active">
    <div class="header"><strong>Asset Inspection</strong></div>
    <div style="padding-top: 10px;">
        <input type="text" id="search-input" class="search-bar" placeholder="Search assets..." onkeyup="renderAssets()">
        
        <button class="btn btn-main" onclick="startQRScan()">üì∑ Scan Asset QR</button>
        <canvas id="qr-scanner"></canvas>

        <div id="asset-container"></div>
        
        <button class="btn btn-save" style="margin-top: 30px;" onclick="finalizeAndSubmit()">Finish & Save to Oracle</button>
        <button class="btn" style="background:#ccc;" onclick="closePlugin()">Close Without Saving</button>
    </div>
</div>

<div id="view-details" class="view">
    <div class="header">
        <button class="btn btn-back" onclick="showView('view-list')">‚Üê Back</button>
        <strong>Inspection Details</strong>
    </div>
    <div style="background: white; padding: 20px; border-radius: 8px; margin-top:15px;">
        <h2 id="asset-name-header" style="margin:0 0 10px 0;"></h2>
        <label style="font-weight:bold;">Condition/Notes:</label>
        <textarea id="asset-notes" placeholder="Enter notes here..."></textarea>
        <button class="btn btn-save" onclick="saveAssetLocally()">Mark as Inspected</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
    let assets = []; 
    let currentAssetId = null;
    let origin = ""; 

    // --- ORACLE OFSC HANDSHAKE ---

    window.addEventListener("message", function(event) {
        if (event.data.method === "init") {
            // CRITICAL: Capture origin immediately to fix Sync Handler error
            origin = event.origin;
            
            // 1. Get the data from Oracle
            const rawList = event.data.activity.asset_list || "";
            
            // 2. Parse the comma-separated string
            if (rawList.trim() !== "") {
                assets = rawList.split(',').map((name, index) => ({
                    id: index + 1,
                    name: name.trim(),
                    status: name.includes("(DONE)") ? "done" : "pending",
                    notes: ""
                }));
            }
            
            // 3. Render and signal Oracle that we are ready
            renderAssets();
            sendReady();
        }
    }, false);

    function sendReady() {
        if (origin) {
            window.parent.postMessage({ method: 'ready' }, origin);
        }
    }

    function finalizeAndSubmit() {
        // Prepare the string to send back: "Asset1(DONE), Asset2(PENDING)"
        const assetSummary = assets.map(a => `${a.name}(${a.status.toUpperCase()})`).join(', ');

        const messageData = {
            method: 'close',
            activity: {
                "asset_list": assetSummary 
            }
        };
        window.parent.postMessage(messageData, origin);
    }

    function closePlugin() {
        window.parent.postMessage({ method: 'close' }, origin);
    }

    // --- APP UI LOGIC ---

    function renderAssets() {
        const container = document.getElementById('asset-container');
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        container.innerHTML = "";

        const filtered = assets.filter(a => a.name.toLowerCase().includes(searchTerm));

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">No assets found in "asset_list".</div>';
            return;
        }

        filtered.forEach(asset => {
            const div = document.createElement('div');
            div.className = `asset-item ${asset.status}`;
            div.onclick = () => openAsset(asset.id);
            div.innerHTML = `
                <div class="asset-info">
                    <b>${asset.name}</b>
                    <span style="font-size:0.8em; color:#666;">Status: ${asset.status.toUpperCase()}</span>
                </div>
                <span>${asset.status === 'done' ? '‚úÖ' : '‚ñ∂Ô∏è'}</span>
            `;
            container.appendChild(div);
        });
    }

    function openAsset(id) {
        currentAssetId = id;
        const asset = assets.find(a => a.id === id);
        document.getElementById('asset-name-header').innerText = asset.name;
        document.getElementById('asset-notes').value = asset.notes;
        showView('view-details');
    }

    function saveAssetLocally() {
        const asset = assets.find(a => a.id === currentAssetId);
        asset.notes = document.getElementById('asset-notes').value;
        asset.status = 'done';
        showView('view-list');
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'view-list') renderAssets();
    }

    // --- QR SCANNER ---
    let videoStream;
    function startQRScan() {
        const canvas = document.getElementById('qr-scanner');
        canvas.style.display = 'block';
        const context = canvas.getContext('2d');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                videoStream = stream;
                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.play();

                function tick() {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.height = video.videoHeight;
                        canvas.width = video.videoWidth;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        if (code) {
                            stopQRScan();
                            const found = assets.find(a => a.name.toLowerCase() === code.data.toLowerCase());
                            if(found) openAsset(found.id);
                            else alert("Asset " + code.data + " not found in list.");
                            return;
                        }
                    }
                    if (videoStream) requestAnimationFrame(tick);
                }
                tick();
            })
            .catch(() => alert('Camera error. Verify HTTPS and Permissions.'));
    }

    function stopQRScan() {
        document.getElementById('qr-scanner').style.display = 'none';
        if(videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }
</script>
</body>
</html>
