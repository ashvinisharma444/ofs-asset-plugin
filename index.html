<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OFS Plugin Failsafe</title>
</head>
<body style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif;">
    <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
        <h2 id="msg">Awaiting Connection...</h2>
        <button onclick="closePlugin()" style="padding: 10px 20px; cursor: pointer;">Return to Oracle</button>
    </div>

    <script>
        var origin = "";

        // Standardized function to talk to Oracle
        function callOracle(data) {
            if (origin) {
                // Some versions of OFS prefer strings, some prefer objects. 
                // We send a string to be safe.
                var message = JSON.stringify(data);
                window.parent.postMessage(message, origin);
            }
        }

        window.addEventListener("message", function(event) {
            // Log to console so you can see it in your debugger
            console.log("Plugin received message:", event.data);

            var data;
            try {
                data = (typeof event.data === 'string') ? JSON.parse(event.data) : event.data;
            } catch (e) {
                console.error("Failed to parse message data");
                return;
            }

            if (data.method === "init") {
                origin = event.origin;
                document.getElementById('msg').innerText = "Connected to Oracle!";

                // MANDATORY HANDSHAKE
                // Sending apiVersion: 1 is often required for the handshake to validate
                callOracle({
                    apiVersion: 1,
                    method: 'ready'
                });
            }
        }, false);

        function closePlugin() {
            callOracle({
                apiVersion: 1,
                method: 'close'
            });
        }
    </script>
</body>
</html>
