<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>OFS Handshake</title>
    </head>
<body style="margin:0; padding:20px; font-family:sans-serif;">

    <div id="app-status">
        <h2>Connecting to Oracle...</h2>
        <p>If you see this, the page has loaded. Waiting for init signal...</p>
    </div>

    <script>
        // Use a global variable for origin to ensure it's available for all functions
        var ofscOrigin = "";

        function sendToOracle(method) {
            if (!ofscOrigin) return;
            
            // Using the strict JSON string format for maximum compatibility
            var message = JSON.stringify({
                apiVersion: 1,
                method: method
            });
            
            console.log("Sending to Oracle:", message);
            window.parent.postMessage(message, ofscOrigin);
        }

        window.addEventListener("message", function(event) {
            console.log("Raw message received:", event.data);

            var data;
            try {
                // Handle both object and string data formats
                data = (typeof event.data === 'string') ? JSON.parse(event.data) : event.data;
            } catch (e) {
                console.error("JSON Parse Error");
                return;
            }

            if (data.method === "init") {
                ofscOrigin = event.origin;
                document.getElementById('app-status').innerHTML = "<h1>Connected!</h1><button onclick='closePlugin()'>Return to OFS</button>";

                // IMMEDIATE HANDSHAKE
                // This stops the 'Reset sync handler' timeout
                sendToOracle('ready');
            }
        }, false);

        function closePlugin() {
            sendToOracle('close');
        }
    </script>
</body>
</html>
