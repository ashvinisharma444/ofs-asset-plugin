<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFS Asset Inspection Plugin</title>
    <style>
        :root { --primary: #0073e6; --success: #28a745; --bg: #f4f7f6; --pending: #ffc107; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        .header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; display: flex; align-items: center; gap: 10px; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .view { display: none; padding: 15px; }
        .view.active { display: block; }

        /* Asset List Styling */
        .asset-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; cursor:pointer; transition: transform 0.1s; }
        .asset-item:active { transform: scale(0.98); }
        .asset-item.done { border-left-color: var(--success); }
        .asset-item.pending { border-left-color: var(--pending); }
        .asset-info b { display: block; font-size: 1.1em; }
        .asset-location { font-size: 0.85em; color: #666; }

        /* Controls */
        .search-bar { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        .filter-container { display: flex; gap: 5px; margin-bottom: 15px; }
        .filter-btn { flex: 1; padding: 10px; font-size: 0.85em; font-weight: bold; border: 1px solid #ddd; border-radius: 6px; background: white; cursor:pointer; }
        .filter-btn.active { background: #eee; border-color: #999; }
        
        /* Form & Buttons */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: #444; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .btn { padding: 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-save { background: var(--success); color: white; margin-top: 20px; }
        .btn-back { background: transparent; color: white; border: 1px solid white; padding: 5px 10px; width: auto; margin: 0; }
        
        #qr-scanner { width: 100%; height: 200px; background: #000; display:none; border-radius: 8px; margin-bottom: 10px; }
        .empty-state { text-align: center; color: #888; margin-top: 40px; }
    </style>
</head>
<body>

<div id="view-list" class="view active">
    <div class="header">
        <strong>Asset Inspection</strong>
    </div>

    <div style="padding-top: 10px;">
        <input type="text" id="search-input" class="search-bar" placeholder="Search assets..." onkeyup="renderAssets()">
        
        <div class="filter-container">
            <button class="filter-btn" onclick="filterStatus('all')">All</button>
            <button class="filter-btn" onclick="filterStatus('pending')">Pending</button>
            <button class="filter-btn" onclick="filterStatus('done')">Done</button>
        </div>

        <button class="btn btn-main" onclick="startQRScan()">üì∑ Scan Asset QR</button>
        <canvas id="qr-scanner"></canvas>

        <div id="asset-container"></div>
        
        <button class="btn btn-save" id="submit-btn" onclick="finalizeAndSubmit()" style="margin-top: 30px;">Finish & Sync to Oracle</button>
        <button class="btn" onclick="closePlugin()" style="background:#ccc; color:#333;">Cancel</button>
    </div>
</div>

<div id="view-details" class="view">
    <div class="header">
        <button class="btn btn-back" onclick="showView('view-list')">‚Üê Back</button>
        <strong id="detail-title">Inspect Asset</strong>
    </div>
    <div class="card">
        <h2 id="asset-name-header" style="margin-top:0;"></h2>
        <p id="asset-status-label"></p>
        
        <label>Inspection Notes</label>
        <textarea id="asset-notes" placeholder="Describe the condition, issues, or repairs made..."></textarea>
        
        <button class="btn btn-save" onclick="saveAssetLocally()">Mark as Inspected</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
    let assets = []; 
    let currentAssetId = null;
    let filteredStatus = 'all';
    let origin = ""; 

    // --- ORACLE OFSC PLUGIN API ---

    window.addEventListener("message", function(event) {
        if (event.data.method === "init") {
            origin = event.origin;
            
            // Read the comma-separated string from the field 'asset_list'
            const rawList = event.data.activity.asset_list || "";
            
            // Convert "a1, a2" into local objects
            if (rawList.trim() !== "") {
                assets = rawList.split(',').map((name, index) => ({
                    id: index + 1,
                    name: name.trim(),
                    status: "pending",
                    notes: ""
                }));
            }
            
            renderAssets();
            sendReady();
        }
    }, false);

    function sendReady() {
        window.parent.postMessage({ method: 'ready' }, origin);
    }

    function closePlugin() {
        window.parent.postMessage({ method: 'close' }, origin);
    }

    function finalizeAndSubmit() {
        // Option A: Send back only names of completed assets
        // Option B: Send back the whole list (current logic)
        const assetSummary = assets.map(a => `${a.name}(${a.status.toUpperCase()})`).join(', ');

        const messageData = {
            method: 'close',
            activity: {
                "asset_list": assetSummary // Updates the field in Oracle
            }
        };
        window.parent.postMessage(messageData, origin);
    }

    // --- APP LOGIC ---

    function renderAssets() {
        const container = document.getElementById('asset-container');
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        container.innerHTML = "";

        const filtered = assets.filter(a => {
            const matchesSearch = a.name.toLowerCase().includes(searchTerm);
            const matchesStatus = (filteredStatus === 'all' || a.status === filteredStatus);
            return matchesSearch && matchesStatus;
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">No assets found.</div>';
            return;
        }

        filtered.forEach(asset => {
            const div = document.createElement('div');
            div.className = `asset-item ${asset.status}`;
            div.onclick = () => openAsset(asset.id);
            div.innerHTML = `
                <div class="asset-info">
                    <b>${asset.name}</b>
                    <span class="asset-location">Status: ${asset.status.toUpperCase()}</span>
                </div>
                <span>${asset.status === 'done' ? '‚úÖ' : '‚ñ∂Ô∏è'}</span>
            `;
            container.appendChild(div);
        });
    }

    function openAsset(id) {
        currentAssetId = id;
        const asset = assets.find(a => a.id === id);
        document.getElementById('asset-name-header').innerText = asset.name;
        document.getElementById('asset-notes').value = asset.notes;
        document.getElementById('asset-status-label').innerText = `Current Status: ${asset.status}`;
        showView('view-details');
    }

    function saveAssetLocally() {
        const asset = assets.find(a => a.id === currentAssetId);
        asset.notes = document.getElementById('asset-notes').value;
        asset.status = 'done';
        showView('view-list');
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'view-list') renderAssets();
    }

    function filterStatus(status) {
        filteredStatus = status;
        renderAssets();
    }

    // --- QR SCANNER LOGIC ---
    let videoStream;
    function startQRScan() {
        const canvas = document.getElementById('qr-scanner');
        canvas.style.display = 'block';
        const context = canvas.getContext('2d');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                videoStream = stream;
                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.play();

                function tick() {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.height = video.videoHeight;
                        canvas.width = video.videoWidth;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        if (code) {
                            stopQRScan();
                            const found = assets.find(a => a.name.toLowerCase() === code.data.toLowerCase());
                            if(found) openAsset(found.id);
                            else alert("Asset " + code.data + " not in current list.");
                            return;
                        }
                    }
                    if (videoStream) requestAnimationFrame(tick);
                }
                tick();
            })
            .catch(() => alert('Camera error. Please ensure HTTPS and permissions.'));
    }

    function stopQRScan() {
        const canvas = document.getElementById('qr-scanner');
        canvas.style.display = 'none';
        if(videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }
</script>
</body>
</html>
